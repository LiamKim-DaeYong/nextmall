name: Auto Update Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate Changelog with OpenAI
        id: changelog
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail
          PR_BODY="${PR_BODY:-}"

          # --- ÏïàÏ†Ñ Ï≤òÎ¶¨: Ìä∏Î†ÅÏºÄÏù¥Ìä∏(ÌÜ†ÌÅ∞ Ï¥àÍ≥º Î∞©ÏßÄ) ---
          MAX_BODY_CHARS=3000
          PR_BODY_TRUNC=$(printf '%s' "$PR_BODY" | cut -c 1-$MAX_BODY_CHARS)
          if [ "${#PR_BODY}" -gt "$MAX_BODY_CHARS" ]; then
            PR_BODY_TRUNC="$PR_BODY_TRUNC\n\n(ÎÇ¥Ïö©Ïù¥ Í∏∏Ïñ¥ ÏùºÎ∂Ä ÎÇ¥Ïö© ÏÉùÎûµ)"
          fi

          # --- ÏïàÏ†ÑÌïú JSON ÏÉùÏÑ±: jqÎ•º ÏÇ¨Ïö©Ìïú Ïù∏Ï†ùÏÖò Î∞©ÏßÄ ---
          system_msg="ÎÑàÎäî changelogÎ•º ÏûëÏÑ±ÌïòÎäî Í∏∞Ïà† Î¨∏ÏÑú Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏Ïïº. Ï∂úÎ†•ÏùÄ Î∞òÎìúÏãú ÏïÑÎûò Ìè¨Îß∑ÏùÑ Îî∞Î•¥Îùº:\n\n## [v{next_version}] - {Ïò§ÎäòÎÇ†Ïßú}\n### {ÏöîÏïΩÏ†úÎ™©}\n\n- {Ïπ¥ÌÖåÍ≥†Î¶¨}\n  - {ÏÑ∏Î∂ÄÌï≠Î™©}\n---"
          user_content="Ï†úÎ™©: ${PR_TITLE}\n\nÎÇ¥Ïö©:\n${PR_BODY_TRUNC}\n\nÏúÑ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú changelog Î∏îÎ°ùÏùÑ ÏÉùÏÑ±Ìï¥Ï§ò."

          payload=$(jq -n --arg model "gpt-4o-mini" \
                          --arg sys "$system_msg" \
                          --arg user "$user_content" \
                          --argjson max_tokens 900 \
                          '{
                            model: $model,
                            messages: [
                              {role:"system", content:$sys},
                              {role:"user", content:$user}
                            ],
                            max_tokens: $max_tokens,
                            temperature: 0.2
                          }')

          # --- OpenAI API Ìò∏Ï∂ú ---
          response_file=$(mktemp)
          OPENAI_URL="https://api.openai.com/v1/chat/completions"

          echo "üì° Sending request to OpenAI..."
          http_code=$(curl -sS -w "%{http_code}" -o "$response_file" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$payload" \
            "$OPENAI_URL" || true)

          # --- HTTP ÏÉÅÌÉú ÏΩîÎìú Í≤ÄÏ¶ù ---
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "::error ::OpenAI API returned HTTP $http_code"
            echo "Response:"
            cat "$response_file" || true
            rm -f "$response_file"
            exit 1
          fi

          # --- ÏùëÎãµ ÌååÏã± ---
          CHOICE_CONTENT=$(jq -r '.choices[0].message.content // empty' "$response_file" || true)
          if [ -z "$CHOICE_CONTENT" ]; then
            echo "::error ::OpenAI ÏùëÎãµÏóêÏÑú contentÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            jq -C . "$response_file" || true
            rm -f "$response_file"
            exit 1
          fi

          echo "ÏÉùÏÑ±Îêú changelog ÎØ∏Î¶¨Î≥¥Í∏∞ (ÏµúÎåÄ 20Ï§Ñ):"
          echo "----------------------------------------"
          echo "$CHOICE_CONTENT" | head -n 20
          echo "----------------------------------------"

          # --- Base64 Ïù∏ÏΩîÎî© ÌõÑ ÏïàÏ†ÑÌïòÍ≤å Ï∂úÎ†• Ï†ÄÏû• ---
          encoded_summary=$(echo "$CHOICE_CONTENT" | base64 -w 0)
          echo "summary=$encoded_summary" >> "$GITHUB_OUTPUT"

          rm -f "$response_file"

      - name: Insert Changelog at top
        run: |
          CHANGELOG_FILE="docs/changelog.md"
          TEMP_FILE="docs/changelog_tmp.md"

          # ÌååÏùº ÏóÜÏùÑ Í≤ΩÏö∞ Ï¥àÍ∏∞ ÏÉùÏÑ±
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "# Changelog" > "$CHANGELOG_FILE"
          fi

          # Base64 ÎîîÏΩîÎî©ÌïòÏó¨ ÎÇ¥Ïö© Î≥µÏõê
          decoded_summary=$(echo "${{ steps.changelog.outputs.summary }}" | base64 --decode)

          # Í∏∞Ï°¥ changelog ÏÉÅÎã®Ïóê ÏÉà ÏÑπÏÖò ÏÇΩÏûÖ
          echo -e "# Changelog\n\n${decoded_summary}\n$(tail -n +2 $CHANGELOG_FILE 2>/dev/null || true)" > "$TEMP_FILE"
          mv "$TEMP_FILE" "$CHANGELOG_FILE"

      - name: Commit and Push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/changelog.md
          git commit -m "docs(changelog): auto update changelog [skip ci]" || echo "No changes to commit"
          git push || echo "‚ö†Ô∏è Push skipped (likely permissions issue or PR context)"
