name: Auto Update Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq gh
          echo "gh CLI ready."

      - name: Fetch CodeRabbit summary
        id: coderabbit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body || 'No summary available.' }}
        run: |
          set -euo pipefail
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Fetching CodeRabbit summary for PR #$PR_NUMBER"

          COMMENTS=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[].body')
          SUMMARY=$(echo "$COMMENTS" | grep -A50 "Summary by CodeRabbit" || true)          

          if [ -z "$SUMMARY" ]; then
            echo "::warning ::CodeRabbit summary not found. Using PR body as fallback."
            SUMMARY="$PR_BODY"
          fi

          echo "summary=$(echo "$SUMMARY" | base64 -w 0)" >> "$GITHUB_OUTPUT"

      - name: Insert or append changelog entry
        run: |
          set -euo pipefail

          CHANGELOG_FILE="docs/changelog.md"
          TEMP_FILE="docs/changelog_tmp.md"
          TEMP_ENTRY="docs/changelog_entry.tmp"
          DECODED_SUMMARY=$(echo "${{ steps.coderabbit.outputs.summary }}" | base64 --decode)
          DATE=$(date +'%Y-%m-%d')

          VERSION_LINE=$(grep -m1 -E '^## \[v[0-9]+\.[0-9]+\.[0-9]+\]' "$CHANGELOG_FILE" 2>/dev/null || echo "")
          if [ -n "$VERSION_LINE" ]; then
            LAST_VERSION=$(echo "$VERSION_LINE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            IFS='.' read -r major minor patch <<< "$LAST_VERSION"
            NEXT_VERSION="$major.$minor.$((patch + 1))"
          else
            NEXT_VERSION="1.0.0"
          fi

          echo "Generating changelog entry for version v$NEXT_VERSION (${DATE})"
          
          {
            printf "### PR #%s\n" "${{ github.event.pull_request.number }}"
            printf "%s\n" "$DECODED_SUMMARY"
            echo ""
          } > "$TEMP_ENTRY"

          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "# Changelog" > "$CHANGELOG_FILE"
          fi

          if grep -q "## \[v${NEXT_VERSION}\] - ${DATE}" "$CHANGELOG_FILE"; then
            echo "Existing version for today detected, appending to that section..."            
            awk -v version="## [v${NEXT_VERSION}]" -v tempfile="$TEMP_ENTRY" '
              $0 ~ version {
                print
                while ((getline line < tempfile) > 0) {
                  print line
                }
                next
              } 1
            ' "$CHANGELOG_FILE" > "$TEMP_FILE"
          else
            echo "Creating new changelog section for v${NEXT_VERSION}"
            {
              echo "# Changelog"
              echo ""
              echo "## [v${NEXT_VERSION}] - ${DATE}"
              cat "$TEMP_ENTRY"
              echo "---"
              tail -n +2 "$CHANGELOG_FILE" 2>/dev/null || true
            } > "$TEMP_FILE"
          fi

          mv "$TEMP_FILE" "$CHANGELOG_FILE"
          rm -f "$TEMP_ENTRY"
          echo "changelog updated successfully at docs/changelog.md"

      - name: Commit and push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/changelog.md
          git commit -m "docs(changelog): auto update from CodeRabbit summary [skip ci]" || echo "No changes to commit"
          git push || echo "Push skipped (PR context or permission issue)"
