# NextMall 프로젝트 컨텍스트

## 프로젝트 목적

- **학습 및 역량 향상**을 위한 이커머스 플랫폼
- 대규모 트래픽 처리, 분산 시스템 설계 등 실무에서 경험하기 어려운 영역 학습
- 실제 서비스 목적이 아닌 **기술 학습**이 주목적
- 설계 원칙: **실무 기준 베스트 프랙티스**

## 개발 환경

- 1인 개발
- 단일 Gradle 프로젝트 + 멀티 모듈 구조
- 한 번에 한 파일씩 작업하며 점진적으로 진행

## 기술 스택

| 영역 | 기술 | 비고 |
|------|------|------|
| Framework | Spring Boot 4.0.1 | 최신 버전 유지 |
| Language | Kotlin | |
| Command | JPA | 쓰기 작업 |
| Query | jOOQ | 읽기 작업 (CQRS) |
| Gateway | Spring Cloud Gateway | WebFlux 기반 |
| BFF | Spring MVC | 오케스트레이션 담당 |
| Database | PostgreSQL | |
| Cache | Redis | 세션, 캐시, 분산 락 |
| Message Queue | Kafka | 이벤트 드리븐 (예정) |
| Test | JUnit 5, Kotest, MockK | Testcontainers 활용 |

## 아키텍처

### 현재 구조 및 확장 방향

```
                        클라이언트
                            │
                            ▼
                ┌───────────────────────┐
                │   api-gateway (8080)  │
                │   - 토큰 존재여부 검증 │
                │   - 라우팅            │
                └───────────┬───────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │   bff-service (8082)  │
                │   - Backend for Frontend
                │   - 오케스트레이션*   │
                └───────────┬───────────┘
                            │
        ┌───────────┬───────┴───────┬───────────┐
        ▼           ▼               ▼           ▼
   ┌─────────┐ ┌─────────┐    ┌─────────┐ ┌─────────┐
   │  auth   │ │  user   │    │ product │ │  order  │
   │ (8081)  │ │ (8083)  │    │ (예정)  │ │ (예정)  │
   └─────────┘ └─────────┘    └─────────┘ └─────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
               ┌─────────┐    ┌─────────┐    ┌─────────┐
               │ payment │    │ coupon  │    │  stock  │
               │ (예정)  │    │ (예정)  │    │ (예정)  │
               └─────────┘    └─────────┘    └─────────┘
```

*\* 빌딩 단계로 BFF에서 오케스트레이션 담당. 복잡도 증가 시 Saga Orchestrator 별도 서비스로 분리 예정*

### 인프라 확장 방향

```
┌─────────────────────────────────────────────────────────────┐
│                     인프라 레이어 (예정)                      │
├─────────────┬─────────────┬─────────────┬─────────────────────┤
│   Kafka     │ Elasticsearch│  Monitoring │    Logging        │
│ (이벤트)    │   (검색)     │ (메트릭)    │   (중앙화)        │
└─────────────┴─────────────┴─────────────┴─────────────────────┘
```

### 핵심 설계 원칙

1. **Gateway**: 토큰 존재여부만 검증, 상세 인증/인가는 하위 서비스에서 처리
2. **Internal Token**: 서비스 간 통신 시 내부 토큰 발행하여 신뢰 구축
3. **CQRS**: JPA(Command) + jOOQ(Query) 분리
4. **단일 책임**: 개별 서비스는 단일 도메인만 담당, 복합 로직은 오케스트레이터에서 조율
5. **이벤트 드리븐**: 서비스 간 강결합 방지를 위해 Kafka 도입 예정

### 내부 서비스 인증 (토큰 교환 패턴)

```
클라이언트 → Gateway → BFF (사용자 토큰 검증)
                        ↓
                   내부 토큰 발급 (사용자 정보 포함)
                        ↓
                   하위 서비스 (내부 토큰만 검증)
```

- **사용자 토큰**: Gateway/BFF에서만 검증, 내부 네트워크에서 사용 안 함
- **내부 토큰**: 서비스 간 통신용, 사용자 정보(userId, roles) 포함, 짧은 만료 시간
- **하위 서비스**: 내부 토큰만 검증, 사용자 토큰 직접 검증 안 함
- **헤더 분리**: `Authorization`(사용자), `X-Internal-Authorization`(내부)

## 프로젝트 구조

```
nextmall/
├── services/           # 배포 단위 (Spring Boot Application)
│   ├── api-gateway     # WebFlux, 라우팅/필터
│   ├── bff-service     # MVC, 오케스트레이션
│   ├── auth-service    # 인증/토큰
│   └── user-service    # 회원 관리
│   └── (확장: product, order, payment, coupon...)
│
├── modules/            # 비즈니스 로직 (Library JAR)
│   ├── auth            # 인증 도메인
│   ├── user            # 회원 도메인
│   └── bff             # BFF 파사드/클라이언트
│   └── (확장: product, order...)
│
└── common/             # 공통 인프라 (Library JAR)
    ├── security        # JWT, Spring Security 통합
    ├── data            # JPA + jOOQ 공통
    ├── exception       # 예외 체계
    ├── redis           # Redis 공통
    ├── identifier      # ID 생성 (Snowflake)
    ├── integration     # 외부 통신 (WebClient)
    └── test-support    # 테스트 공통
```

## 협업 규칙

1. **한 번에 한 파일씩**: 방향성 합의 후 클래스 파일 하나씩 작업
2. **Claude 역할**: 시니어 개발자로서 베스트 프랙티스 기반 가이드
3. **실무 수준 설계**: 학습 목적이지만 실제 운영 가능한 수준 지향
4. **코드 수정 전 확인**: 큰 변경은 방향성 먼저 논의

## 학습 목표 주제

- 대규모 트래픽 처리 설계
- 동시성 제어 (분산 락, 낙관적/비관적 락)
- 이벤트 드리븐 아키텍처 (Kafka)
- CQRS 패턴
- 마이크로서비스 간 통신 및 인증
- 장애 대응 (Circuit Breaker, Retry, Fallback)
- 캐시 전략 (Cache Aside, Write Through 등)
- 성능 테스트 (k6)
- 모니터링/로깅
